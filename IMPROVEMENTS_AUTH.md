# Улучшения авторизации на Wildberries

## Внесенные улучшения

На основе анализа репозиториев GitHub и лучших практик работы с Selenium, были внесены следующие улучшения в авторизацию:

### 1. Улучшенная проверка авторизации

Добавлена функция `check_authorization()` которая проверяет авторизацию несколькими способами:
- ✅ Проверка URL (нет `/login`, `/auth`, `/signin`)
- ✅ Проверка важных cookies авторизации (`WILDAUTHNEW_V3`, `WBToken`, `x-supplier-id`, `WBUID`)
- ✅ Проверка localStorage/sessionStorage (может содержать токены)
- ✅ Поиск элементов кабинета продавца на странице
- ✅ Финальная проверка URL после небольших задержек

### 2. Сохранение и загрузка LocalStorage/SessionStorage

- ✅ Сохранение данных из localStorage и sessionStorage в отдельный файл
- ✅ Автоматическая загрузка сохраненных данных при старте
- ✅ Это позволяет сохранить больше данных сессии помимо cookies

### 3. Использование профиля браузера

Добавлена возможность использовать постоянный профиль браузера:
- ✅ Переменная `USE_BROWSER_PROFILE=true` в `.env`
- ✅ Переменная `BROWSER_PROFILE_PATH` для указания пути к профилю
- ✅ Автоматическое создание временного профиля если путь не указан

**Преимущества:**
- Браузер сохраняет сессию автоматически
- Меньше проблем с истекшими cookies
- Более стабильная авторизация

### 4. Антидетект настройки

Добавлены настройки чтобы браузер не выглядел как автоматизированный:
- ✅ Установлен реальный User-Agent
- ✅ Отключены флаги автоматизации через `excludeSwitches`
- ✅ Удаление свойства `navigator.webdriver` через CDP

### 5. Улучшенная обработка cookies

- ✅ Проверка наличия важных cookies авторизации перед сохранением
- ✅ Более подробное логирование процесса
- ✅ Сохранение JSON версии для отладки

## Использование

### Базовая настройка (как было)

```bash
# В .env файле
HEADLESS_BROWSER=false  # Для первой авторизации
```

### Использование профиля браузера (рекомендуется)

```bash
# В .env файле
USE_BROWSER_PROFILE=true
BROWSER_PROFILE_PATH=C:\Users\YourName\AppData\Local\Google\Chrome\User Data\Profile 1
```

Или создайте отдельный профиль:
```bash
USE_BROWSER_PROFILE=true
# Если BROWSER_PROFILE_PATH не указан, будет создан временный профиль в wb_browser_profile/
```

## Как это работает

1. **Первая авторизация:**
   - Браузер открывается в видимом режиме
   - Пользователь авторизуется через SMS вручную
   - Все cookies и данные хранилища сохраняются

2. **Последующие запуски:**
   - Загружаются сохраненные cookies
   - Загружаются данные localStorage/sessionStorage
   - Если используется профиль браузера - данные берутся из профиля
   - Проверяется авторизация несколькими способами
   - Если авторизация не прошла - дается возможность авторизоваться вручную

## Решение проблем

### Cookies истекли

**Решение 1:** Используйте профиль браузера
```bash
USE_BROWSER_PROFILE=true
```

**Решение 2:** Удалите старые cookies и авторизуйтесь заново
```bash
rm wb_cookies.pkl
rm wb_cookies.json
rm wb_cookies.storage.json
```

### Авторизация не проходит проверку

Проверьте файл `wb_cookies.json` - там должны быть важные cookies:
- `WILDAUTHNEW_V3`
- `WBToken`
- `x-supplier-id`

Если их нет - авторизуйтесь заново.

### Браузер определяется как бот

Проверьте что установлен User-Agent (добавлено автоматически). Если проблема сохраняется, используйте профиль браузера.

## Найденные решения на GitHub

При реализации улучшений использованы подходы из следующих репозиториев:
- MarketplacesGoodsTracker - работа с cookies и сессиями
- ResponseBot - проверка авторизации и работа с профилями браузеров

## Дополнительные улучшения (можно добавить)

1. **2captcha интеграция** - для автоматического решения капчи (если появится)
2. **Ротация User-Agent** - для еще большего антидетекта
3. **Прокси поддержка** - для работы через прокси
4. **Множественные профили** - для работы с несколькими аккаунтами

## Примечания

- WB использует SMS для авторизации, поэтому полностью автоматическая авторизация невозможна
- Cookies обычно действуют несколько дней/недель
- Профиль браузера - самый надежный способ сохранить сессию
- Все изменения обратно совместимы - старый код продолжит работать

